{% extends "base.html" %}

{% block title %}Worker Dashboard - Find My Worker{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold mb-2">Welcome, {{ worker.name }}!</h2>
    <p class="text-gray-600">Manage your bookings and grow your business</p>
</div>

<!-- Stats Overview -->
<div class="grid md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-rupee-sign text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">₹{{ earnings.total_earnings or 0 }}</h3>
        <p class="text-green-100">Total Earnings</p>
    </div>
    
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-briefcase text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ earnings.completed_jobs or 0 }}</h3>
        <p class="text-blue-100">Jobs Completed</p>
    </div>
    
    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-star text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ worker.rating }}</h3>
        <p class="text-yellow-100">Average Rating</p>
    </div>
    
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-clock text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ pending_requests|length }}</h3>
        <p class="text-purple-100">Pending Requests</p>
    </div>
</div>

<div class="grid lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2">
        <!-- Profile Overview -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold">Your Profile</h2>
                <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-edit mr-1"></i>Edit Profile
                </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6 mb-4">
                <div>
                    <p class="text-gray-600 mb-2"><strong>Email:</strong> {{ worker.email }}</p>
                    <p class="text-gray-600 mb-2"><strong>Phone:</strong> {{ worker.phone }}</p>
                    <p class="text-gray-600 mb-2"><strong>Location:</strong> {{ worker.locality }}</p>
                </div>
                <div>
                    <p class="text-gray-600 mb-2"><strong>Experience:</strong> {{ worker.experience }} years</p>
                    <p class="text-gray-600 mb-2"><strong>Hourly Rate:</strong> 
                        <span class="text-green-600 font-semibold">₹{{ worker.hourly_rate }}</span>
                    </p>
                    <p class="text-gray-600 mb-2"><strong>Status:</strong> 
                        <span class="px-2 py-1 rounded-full text-xs font-medium
                                   {{ 'bg-green-100 text-green-800' if worker.availability == 'available' else 'bg-red-100 text-red-800' }}">
                            {{ worker.availability.title() }}
                        </span>
                    </p>
                </div>
            </div>
            
            <div class="mb-4">
                <strong class="text-gray-700">Skills:</strong>
                <div class="flex flex-wrap gap-2 mt-2">
                    {% for skill in worker.skills.split(',') %}
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                        {{ skill.strip() }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Badges -->
            <div class="flex flex-wrap gap-2 mb-4">
                {% if worker.police_verified %}
                <span class="badge badge-verified"><i class="fas fa-shield-alt mr-1"></i>Police Verified</span>
                {% endif %}
                {% if worker.eco_friendly %}
                <span class="badge badge-eco"><i class="fas fa-leaf mr-1"></i>Eco-Friendly</span>
                {% endif %}
                {% if worker.vaccination_status == 'fully_vaccinated' %}
                <span class="badge badge-vaccinated"><i class="fas fa-syringe mr-1"></i>Vaccinated</span>
                {% endif %}
            </div>
            
            {% if worker.description %}
            <div>
                <strong class="text-gray-700">About:</strong>
                <p class="text-gray-600 mt-2">{{ worker.description }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Earnings Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-chart-line text-green-500 mr-2"></i>Earnings Trend
            </h3>
            {% if weekly_earnings %}
            {% set max_earnings = (weekly_earnings | map(attribute='earnings') | max) or 1 %}
            <div class="h-64 flex items-end justify-between space-x-2">
                {% for week in weekly_earnings %}
                <div class="flex-1 flex flex-col items-center">
                    <div class="bg-green-500 w-full rounded-t chart-bar" 
                         data-height="{{ (((week.earnings or 0) / max_earnings) * 100)|round }}">
                    </div>
                    <p class="text-xs text-gray-600 mt-2">Week {{ loop.index }}</p>
                    <p class="text-xs font-semibold">₹{{ week.earnings }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-center text-gray-500 py-8">No earnings data yet</p>
            {% endif %}
            
            <div class="mt-6 grid md:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Avg. Job Value</p>
                    <p class="text-2xl font-bold text-green-600">₹{{ (earnings.avg_job_value or 0)|round }}</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">This Month</p>
                    <p class="text-2xl font-bold text-blue-600">
                        ₹{{ weekly_earnings[-4:]|sum(attribute='earnings') if weekly_earnings else 0 }}
                    </p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Completion Rate</p>
                    <p class="text-2xl font-bold text-purple-600">95%</p>
                </div>
            </div>
        </div>
        
        <!-- Pending Requests -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">
                Pending Service Requests 
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm ml-2">
                    {{ pending_requests|length }}
                </span>
            </h3>
            
            {% if pending_requests %}
            <div class="space-y-4">
                {% for request in pending_requests %}
                <div class="border-l-4 border-blue-500 bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg">{{ request.service_type }}</h4>
                            <p class="text-gray-600 text-sm"><i class="fas fa-user mr-1"></i>{{ request.customer_name }}</p>
                            <p class="text-gray-600 text-sm"><i class="fas fa-phone mr-1"></i>{{ request.customer_phone }}</p>
                            <p class="text-gray-600 text-sm"><i class="fas fa-map-marker-alt mr-1"></i>{{ request.locality }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-600">₹{{ request.final_price }}</p>
                            <p class="text-sm text-gray-500">{{ request.preferred_date }}</p>
                            <p class="text-sm text-gray-500">{{ request.preferred_time }}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-sm text-gray-700 mb-1"><strong>Details:</strong></p>
                        <p class="text-sm text-gray-600">{{ request.description }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-sm text-gray-700 mb-1"><strong>Location:</strong></p>
                        <p class="text-sm text-gray-600">{{ request.location }}</p>
                    </div>
                    
                    <!-- Price Breakdown -->
                    <div class="bg-white p-3 rounded mb-3 text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-600">Labor:</span>
                            <span>₹{{ request.labor_cost }}</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-600">Materials:</span>
                            <span>₹{{ request.material_cost }}</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-600">Tax:</span>
                            <span>₹{{ request.tax }}</span>
                        </div>
                        {% if request.surge_multiplier > 1.0 %}
                        <div class="flex justify-between text-orange-600">
                            <span>Surge ({{ request.surge_multiplier }}x):</span>
                            <span>Applied</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="flex space-x-3">
                        <a href="{{ url_for('manage_request', request_id=request.id, action='accept') }}" 
                           class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 flex-1 text-center font-semibold">
                            <i class="fas fa-check mr-1"></i>Accept
                        </a>
                        <a href="{{ url_for('manage_request', request_id=request.id, action='decline') }}" 
                           class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 flex-1 text-center font-semibold">
                            <i class="fas fa-times mr-1"></i>Decline
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No pending requests at the moment</p>
                <p class="text-sm text-gray-400">New requests will appear here</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <button onclick="toggleAvailability()" 
                        class="w-full bg-green-50 p-3 rounded-lg hover:bg-green-100 text-left transition-colors">
                    <i class="fas fa-toggle-on text-green-500 mr-2"></i>
                    <span class="font-medium">Toggle Availability</span>
                </button>
                <a href="{{ url_for('worker_training') }}" 
                   class="block bg-blue-50 p-3 rounded-lg hover:bg-blue-100 transition-colors">
                    <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>
                    <span class="font-medium">Skill Training</span>
                </a>
                <button onclick="viewSchedule()" 
                        class="w-full bg-yellow-50 p-3 rounded-lg hover:bg-yellow-100 text-left transition-colors">
                    <i class="fas fa-calendar text-yellow-500 mr-2"></i>
                    <span class="font-medium">View Schedule</span>
                </button>
                <button onclick="optimizeRoute()" 
                        class="w-full bg-purple-50 p-3 rounded-lg hover:bg-purple-100 text-left transition-colors">
                    <i class="fas fa-route text-purple-500 mr-2"></i>
                    <span class="font-medium">Optimize Routes</span>
                </button>
                <button onclick="updateMyLocation()" 
                        class="w-full bg-green-50 p-3 rounded-lg hover:bg-green-100 text-left transition-colors">
                    <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                    <span class="font-medium">Update My Location</span>
                </button>
            </div>
        </div>
        
        <!-- Location Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>Location Status
            </h3>
            <div id="location-status" class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Current Location:</span>
                    <span id="location-text" class="text-sm font-medium text-gray-900">Loading...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Last Update:</span>
                    <span id="last-update" class="text-sm text-gray-500">-</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Location Sharing:</span>
                    <span id="location-sharing-status" class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        Checking...
                    </span>
                </div>
            </div>
        </div>

        <!-- Performance Insights -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Performance Insights
            </h3>
            <div class="space-y-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Response Rate</p>
                    <p class="text-2xl font-bold text-green-600">98%</p>
                    <p class="text-xs text-gray-500">Great job!</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Customer Satisfaction</p>
                    <p class="text-2xl font-bold text-blue-600">4.8/5</p>
                    <p class="text-xs text-gray-500">Above average</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">On-Time Arrival</p>
                    <p class="text-2xl font-bold text-purple-600">95%</p>
                    <p class="text-xs text-gray-500">Keep it up!</p>
                </div>
            </div>
        </div>
        
        <!-- Tips & Tricks -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-info-circle mr-2"></i>Pro Tip
            </h3>
            <p class="text-sm text-blue-100 mb-3">
                Workers who respond within 1 hour get 3x more bookings!
            </p>
            <button class="bg-white text-blue-600 px-4 py-2 rounded font-semibold text-sm hover:bg-blue-50">
                Learn More
            </button>
        </div>
    </div>
</div>

<script>
// Set chart bar heights dynamically
document.addEventListener('DOMContentLoaded', function() {
    const chartBars = document.querySelectorAll('.chart-bar');
    chartBars.forEach(bar => {
        const height = bar.getAttribute('data-height');
        bar.style.height = height + '%';
    });
    
    // Load location status for workers
    loadLocationStatus();
});

function toggleAvailability() {
    if (confirm('Do you want to toggle your availability status?')) {
        alert('Availability updated successfully!');
        location.reload();
    }
}

function viewSchedule() {
    alert('Schedule optimization feature coming soon! This will help you plan your day efficiently.');
}

function optimizeRoute() {
    alert('Route optimization will suggest the best order to complete multiple jobs in your area, saving travel time and fuel costs.');
}

function updateMyLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }

    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
    button.disabled = true;

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            fetch('/update_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Location updated successfully! You will now receive nearby job notifications.');
                    loadLocationStatus();
                } else {
                    alert('Error updating location: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating location. Please try again.');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        },
        function(error) {
            let errorMessage = 'Error getting location: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Location access denied. Please enable location services.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out.';
                    break;
                default:
                    errorMessage += 'Unknown error occurred.';
                    break;
            }
            alert(errorMessage);
            button.innerHTML = originalText;
            button.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
        }
    );
}

function loadLocationStatus() {
    fetch('/worker_location_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const location = data.location;
                const locationText = document.getElementById('location-text');
                const lastUpdate = document.getElementById('last-update');
                const locationStatus = document.getElementById('location-sharing-status');
                
                if (location.has_location) {
                    locationText.textContent = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
                    locationStatus.textContent = 'Active';
                    locationStatus.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                } else {
                    locationText.textContent = 'Not Set';
                    locationStatus.textContent = 'Inactive';
                    locationStatus.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                }
                
                if (location.last_update) {
                    const updateTime = new Date(location.last_update);
                    lastUpdate.textContent = updateTime.toLocaleString();
                } else {
                    lastUpdate.textContent = 'Never';
                }
            }
        })
        .catch(error => {
            console.error('Error loading location status:', error);
        });
}
</script>
{% endblock %}