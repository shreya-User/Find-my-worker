{% extends "base.html" %}

{% block title %}Dashboard - Find My Worker{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold mb-2">Welcome, {{ session.user_name }}!</h2>
    <p class="text-gray-600">Find and book skilled professionals in {{ session.user_locality }}, {{ session.user_city }}</p>
</div>

<!-- Quick Actions Bar -->
<div class="grid md:grid-cols-4 gap-4 mb-8">
    <a href="{{ url_for('subscription_plans') }}" class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white p-4 rounded-lg hover:shadow-lg transition-all">
        <i class="fas fa-crown text-2xl mb-2"></i>
        <h3 class="font-bold">Go Premium</h3>
        <p class="text-sm">Save 20% on services</p>
    </a>
    <a href="{{ url_for('loyalty_rewards') }}" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg hover:shadow-lg transition-all">
        <i class="fas fa-gift text-2xl mb-2"></i>
        <h3 class="font-bold">{{ session.loyalty_points }} Points</h3>
        <p class="text-sm">Redeem rewards</p>
    </a>
    <button onclick="showEmergencySOS()" class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg hover:shadow-lg transition-all text-left">
        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
        <h3 class="font-bold">Emergency SOS</h3>
        <p class="text-sm">Get immediate help</p>
    </button>
    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
        <i class="fas fa-calendar-check text-2xl mb-2"></i>
        <h3 class="font-bold">{{ recent_requests|length }}</h3>
        <p class="text-sm">Active bookings</p>
    </div>
</div>

<!-- AI Recommendations -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h3 class="text-2xl font-semibold mb-4">
        <i class="fas fa-robot text-blue-500 mr-2"></i>AI Recommendations for You
    </h3>
    
    {% if recommendations.seasonal %}
    <div class="mb-6">
        <h4 class="font-semibold mb-3 flex items-center">
            <i class="fas fa-sun text-yellow-500 mr-2"></i>Seasonal Services
        </h4>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
            {% for service in recommendations.seasonal %}
            <a href="{{ url_for('browse_services', category=service.name) }}" 
               class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center hover:shadow-md transition-all">
                <i class="fas {{ service.icon }} text-3xl text-blue-600 mb-2"></i>
                <p class="text-sm font-medium">{{ service.name }}</p>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if recommendations.trending %}
    <div class="mb-6">
        <h4 class="font-semibold mb-3 flex items-center">
            <i class="fas fa-fire text-red-500 mr-2"></i>Trending in Your Area
        </h4>
        <div class="flex flex-wrap gap-2">
            {% for trend in recommendations.trending %}
            <a href="{{ url_for('browse_services', category=trend.service_type) }}" 
               class="bg-red-50 text-red-700 px-4 py-2 rounded-full text-sm hover:bg-red-100">
                {{ trend.service_type }} ({{ trend.bookings }} bookings)
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if recommendations.personal %}
    <div>
        <h4 class="font-semibold mb-3 flex items-center">
            <i class="fas fa-history text-green-500 mr-2"></i>Based on Your History
        </h4>
        <div class="flex flex-wrap gap-2">
            {% for hist in recommendations.personal %}
            <a href="{{ url_for('browse_services', category=hist.service_type) }}" 
               class="bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm hover:bg-green-100">
                {{ hist.service_type }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Service Categories -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h3 class="text-2xl font-semibold mb-4">Browse All Services</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
        {% for category in service_categories %}
        <a href="{{ url_for('browse_services', category=category.name) }}" 
           class="p-4 border rounded-lg hover:border-blue-500 hover:shadow-md transition-all text-center">
            <i class="fas {{ category.icon }} text-4xl text-blue-600 mb-2"></i>
            <p class="text-sm font-medium">{{ category.name }}</p>
            <p class="text-xs text-gray-500">from ₹{{ category.base_price }}</p>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Top Workers -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h3 class="text-2xl font-semibold mb-4">Top Rated in Your Locality</h3>
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for worker in local_workers %}
        <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-semibold text-lg">{{ worker.name }}</h4>
                    <p class="text-xs text-gray-600">{{ worker.locality }}</p>
                </div>
                <div class="text-yellow-500 text-sm">
                    <i class="fas fa-star"></i> {{ worker.rating }}
                </div>
            </div>
            
            <div class="mb-3">
                <div class="flex flex-wrap gap-1 mb-2">
                    {% if worker.police_verified %}
                    <span class="badge badge-verified"><i class="fas fa-shield-alt mr-1"></i>Verified</span>
                    {% endif %}
                    {% if worker.eco_friendly %}
                    <span class="badge badge-eco"><i class="fas fa-leaf mr-1"></i>Eco</span>
                    {% endif %}
                </div>
                <p class="text-sm text-gray-700 line-clamp-2">{{ worker.skills }}</p>
            </div>
            
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-green-600">₹{{ worker.hourly_rate }}/hr</span>
                <a href="{{ url_for('book_service', worker_id=worker.id) }}" 
                   class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                    Book Now
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Recent Bookings -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-2xl font-semibold mb-4">Your Recent Bookings</h3>
    {% if recent_requests %}
    <div class="space-y-3">
        {% for request in recent_requests %}
        <div class="border-l-4 {{ 'border-green-500' if request.status == 'completed' else 'border-blue-500' if request.status == 'accepted' else 'border-yellow-500' }} p-4 bg-gray-50 rounded">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold">{{ request.service_type }}</h4>
                    <p class="text-sm text-gray-600">{{ request.worker_name or 'Waiting for assignment' }}</p>
                    <p class="text-xs text-gray-500">{{ request.preferred_date }} at {{ request.preferred_time }}</p>
                </div>
                <div class="text-right">
                    <span class="px-3 py-1 rounded-full text-xs font-medium
                               {{ 'bg-green-100 text-green-800' if request.status == 'completed' else
                                  'bg-blue-100 text-blue-800' if request.status == 'accepted' else
                                  'bg-yellow-100 text-yellow-800' }}">
                        {{ request.status.title() }}
                    </span>
                    <p class="text-lg font-bold text-gray-800 mt-1">₹{{ request.final_price }}</p>
                </div>
            </div>
            {% if request.status == 'accepted' %}
            <div class="mt-3">
                <a href="{{ url_for('track_service', request_id=request.id) }}" 
                   class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 inline-block">
                    <i class="fas fa-map-marker-alt mr-1"></i>Track Service
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-gray-500 py-8">No bookings yet. Start by browsing services!</p>
    {% endif %}
</div>

<!-- Emergency SOS Modal -->
<div id="sosModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-red-600 mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>Emergency SOS
        </h3>
        <p class="mb-4">This will immediately alert our support team and can notify local authorities if needed.</p>
        <p class="mb-6 text-sm text-gray-600">Please only use this feature in genuine emergencies.</p>
        <div class="flex space-x-3">
            <button onclick="triggerSOS()" 
                    class="flex-1 bg-red-500 text-white py-3 px-6 rounded-lg hover:bg-red-600 font-semibold">
                Send Alert
            </button>
            <button onclick="closeSOS()" 
                    class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-400 font-semibold">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Somewhere in the dashboard content -->
<section class="mt-6">
  <h3 class="font-bold mb-2">Nearby Workers</h3>
  <div id="nearby-workers" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3"></div>
</section>

<!-- Floating Chat Button -->
<a href="{{ url_for('chatbot_widget') }}" target="_blank" 
   style="position: fixed; bottom: 20px; right: 20px; 
          width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); 
          border-radius: 50%; display: flex; align-items: center; justify-content: center; 
          color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
          text-decoration: none; z-index: 1000;">
    <i class="fas fa-comments"></i>
</a>
<script>
async function loadNearbyWorkers() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const res = await fetch(`/api/nearby_workers?lat=${lat}&lon=${lon}&radius_km=8`, { credentials: 'same-origin' });
    if (!res.ok) return;
    const data = await res.json();
    const box = document.getElementById('nearby-workers');
    if (!box) return;
    box.innerHTML = (data.workers || []).slice(0, 8).map(w => `
      <div class="p-3 border rounded-lg">
        <div><strong>${w.name}</strong> — ${w.locality || ''}, ${w.city || ''}</div>
        <div>${w.skills || ''}</div>
        <div>⭐ ${w.rating || '—'} • ${w.distance_km} km away</div>
      </div>
    `).join('') || '<p>No nearby workers found.</p>';
  }, () => {}, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
}
document.addEventListener('DOMContentLoaded', loadNearbyWorkers);
</script>

<!-- Place near the bottom of user_dashboard.html -->
<script>
async function triggerSOS() {
  try {
    const coords = await new Promise((resolve) => {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
        () => resolve(null),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    });

    const payload = coords || {};
    const res = await fetch('/sos_alert', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok || data.success === false) {
      alert(data.message || 'Failed to send SOS');
      return;
    }
    alert('SOS sent to admin. Help is on the way.');
  } catch (e) {
    alert('Network error sending SOS');
  }
}
</script>
<script> function showEmergencySOS() { document.getElementById('sosModal').classList.remove('hidden'); } function closeSOS() { document.getElementById('sosModal').classList.add('hidden'); } </script>

{% endblock %}