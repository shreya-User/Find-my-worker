{% extends "base.html" %}

{% block title %}Admin Dashboard - Find My Worker{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold mb-2">Admin Dashboard</h2>
    <p class="text-gray-600">Manage workers and view system statistics</p>
</div>

<!-- Statistics Cards -->
<div class="grid md:grid-cols-5 gap-6 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-users text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ stats.total_workers or 0 }}</h3>
        <p class="text-blue-100">Total Workers</p>
    </div>
    
    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-check-circle text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ stats.available_workers or 0 }}</h3>
        <p class="text-green-100">Available</p>
    </div>
    
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-shield-alt text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ stats.verified_workers or 0 }}</h3>
        <p class="text-purple-100">Verified</p>
    </div>
    
    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-leaf text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ stats.eco_workers or 0 }}</h3>
        <p class="text-yellow-100">Eco-Friendly</p>
    </div>
    
    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-lg shadow-lg">
        <i class="fas fa-star text-4xl mb-3"></i>
        <h3 class="text-3xl font-bold">{{ "%.1f"|format(stats.avg_rating or 0) }}</h3>
        <p class="text-red-100">Avg Rating</p>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
    <div class="flex flex-wrap gap-4">
        <a href="{{ url_for('add_worker') }}" 
           class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold">
            <i class="fas fa-plus mr-2"></i>Add New Worker
        </a>
        <button onclick="exportWorkers()" 
                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold">
            <i class="fas fa-download mr-2"></i>Export Workers
        </button>
        <button onclick="refreshData()" 
                class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 font-semibold">
            <i class="fas fa-sync mr-2"></i>Refresh Data
        </button>
    </div>
</div>

<!-- Workers Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">All Workers</h3>
    </div>
    
    {% if workers %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Worker</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skills</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Experience</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for worker in workers %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">
                                    {{ worker.name[0].upper() }}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ worker.name }}</div>
                                <div class="text-sm text-gray-500">{{ worker.city }}, {{ worker.locality }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ worker.email }}</div>
                        <div class="text-sm text-gray-500">{{ worker.phone }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 max-w-xs truncate">{{ worker.skills }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-900">{{ worker.experience }} years</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-semibold text-green-600">₹{{ worker.hourly_rate }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="text-sm text-gray-900">{{ "%.1f"|format(worker.rating) }}</span>
                            <div class="ml-1 flex">
                                {% for i in range(5) %}
                                    {% if i < worker.rating %}
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    {% else %}
                                        <i class="far fa-star text-gray-300 text-xs"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                   {% if worker.availability == 'available' %}
                                       bg-green-100 text-green-800
                                   {% elif worker.availability == 'busy' %}
                                       bg-yellow-100 text-yellow-800
                                   {% else %}
                                       bg-red-100 text-red-800
                                   {% endif %}">
                            {{ worker.availability.title() }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="viewWorker({{ worker.id }})" 
                                    class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editWorker({{ worker.id }})" 
                                    class="text-green-600 hover:text-green-900">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteWorker({{ worker.id }})" 
                                    class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 text-lg">No workers found</p>
        <p class="text-sm text-gray-400">Add your first worker to get started</p>
    </div>
    {% endif %}
</div>

<!-- Verification Badges Info -->
<div class="mt-8 grid md:grid-cols-3 gap-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h4 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fas fa-shield-alt text-green-500 mr-2"></i>Police Verified
        </h4>
        <p class="text-sm text-gray-600">Workers who have completed police verification for enhanced safety and trust.</p>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h4 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fas fa-leaf text-green-500 mr-2"></i>Eco-Friendly
        </h4>
        <p class="text-sm text-gray-600">Workers who use environmentally friendly practices and materials.</p>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h4 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fas fa-syringe text-blue-500 mr-2"></i>Vaccination Status
        </h4>
        <p class="text-sm text-gray-600">Workers' vaccination status for health and safety compliance.</p>
    </div>
</div>

<!-- Add inside admin_dashboard.html content -->
<section class="card" style="margin-top:16px;">
  <h3 style="font-weight:600;margin-bottom:8px;">SOS Alerts</h3>
  <div id="sos-alerts" style="display:grid;gap:12px;"></div>
</section>

<script>
async function loadSosAlerts() {
  try {
    const res = await fetch('/api/sos_alerts', { credentials: 'same-origin' });
    if (!res.ok) return;
    const data = await res.json();
    const container = document.getElementById('sos-alerts');
    if (!Array.isArray(data.alerts) || data.alerts.length === 0) {
      container.innerHTML = '<p>No alerts</p>';
      return;
    }
    container.innerHTML = '';
    for (const a of data.alerts) {
      const item = document.createElement('div');
      item.style.padding = '10px';
      item.style.border = '1px solid #eee';
      item.style.borderRadius = '8px';
      item.innerHTML = `
        <div><strong>${a.user_name || 'Unknown'}</strong> — ${a.locality || ''}, ${a.city || ''}</div>
        <div>${a.timestamp || ''}</div>
        <div>${(a.latitude != null && a.longitude != null) ? ('Lat: ' + a.latitude + ', Lon: ' + a.longitude) : ''}</div>
        <div>${(a.worker && a.worker.worker_name) ? ('Worker: ' + a.worker.worker_name + ' (' + (a.worker.worker_phone || '') + ')') : ''}</div>
      `;
      container.appendChild(item);
    }
  } catch (e) {
    // Optional: show a transient error
  }
}
document.addEventListener('DOMContentLoaded', () => {
  loadSosAlerts();
  setInterval(loadSosAlerts, 15000);
});
</script>


<script>
function viewWorker(workerId) {
    // Implement worker view functionality
    alert(`View worker details for ID: ${workerId}`);
}

function editWorker(workerId) {
    // Implement worker edit functionality
    alert(`Edit worker with ID: ${workerId}`);
}

function deleteWorker(workerId) {
    if (confirm('Are you sure you want to delete this worker? This action cannot be undone.')) {
        // Implement worker deletion
        alert(`Delete worker with ID: ${workerId}`);
    }
}

function exportWorkers() {
    // Implement export functionality
    alert('Export functionality will be implemented soon!');
}

function refreshData() {
    location.reload();
}
</script>
{% endblock %}


